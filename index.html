<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sfida</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<style>
  :root{
    --ink:#4a3f30;
    --paper:#f7f3eb;
    --overlay:rgba(255,255,255,0.55);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body {
    margin: 0;
    padding: 40px 20px;
    font-family: Georgia, "Times New Roman", Times, serif;
    background: url('https://cdn.pixabay.com/photo/2017/11/10/05/00/paper-2934291_1280.jpg') no-repeat center center fixed;
    background-size: cover;
    color: var(--ink);
    display: grid;
    place-items: center;
  }
  .card{
    width:min(920px, 100%);
    background: var(--overlay);
    backdrop-filter: blur(2px);
    border: 1px solid #e5e5e5;
    border-radius: 18px;
    padding: clamp(16px, 4vw, 36px);
    text-align:center;
    text-shadow: 0 1px 0 rgba(255,255,255,0.4);
  }
  h1 {
    font-size: clamp(32px, 6vw, 64px);
    margin: 0 0 .2em 0;
    font-weight: 400;
  }
  p.description {
    font-size: clamp(16px, 3.2vw, 22px);
    margin: 0 0 1.4em 0;
    font-style: italic;
  }
  p.challenge {
    font-size: clamp(22px, 4.8vw, 36px);
    font-weight: bold;
    margin: 0 0 1.2em 0;
    line-height: 1.25;
  }
  p.thanks {
    font-size: clamp(14px, 3vw, 18px);
    font-style: italic;
    margin: 1.2em 0 0 0;
  }
  .actions{
    display:flex;
    gap:12px;
    justify-content:center;
    flex-wrap:wrap;
    margin-top: .6em;
  }
  button, .linklike{
    font: inherit;
    padding: .7em 1.1em;
    border-radius: 999px;
    border: 1px solid #c8bca8;
    background: #fff;
    cursor: pointer;
    transition: transform .05s ease;
  }
  button:hover{transform: translateY(-1px)}
  .muted{
    border: none;
    background: transparent;
    text-decoration: underline;
    padding: 0.3em 0.5em;
  }
  noscript{
    display:block; margin-top:12px; color:#7a6a54; font-size:14px;
  }
</style>
</head>
<body>
  <main class="card" role="main" aria-live="polite">
    <h1>Sfida</h1>
    <p class="description">Un piccolo gioco per rendere la festa ancora pi√π speciale.</p>
    <p class="challenge" id="challengeText" aria-label="Testo della sfida"></p>

    <div class="actions">
      <button id="copyBtn" type="button">Copia la sfida</button>
      <button id="shareBtn" type="button">Condividi</button>
      <button id="newBtn" class="muted" type="button" title="Cambia sfida (se permesso)">Nuova sfida</button>
    </div>

    <p class="thanks">Grazie per partecipare e rendere questo giorno indimenticabile.</p>

    <noscript>Attiva JavaScript per vedere la sfida.</noscript>
  </main>

  <script>
    // ‚Äî‚Äî‚Äî‚Äî‚Äî CONFIGURAZIONE ‚Äî‚Äî‚Äî‚Äî‚Äî
    const challenges = [
      "Vai a fare un brindisi con uno sconosciuto.",
      "Racconta agli sposi il tuo pi√π bel ricordo con loro.",
      "Balla la tua canzone preferita per almeno un minuto.",
      "Scatta una foto divertente con qualcuno che non conosci.",
      "Fai un complimento sincero a due persone che non conosci."
    ];

    // Permetti ‚ÄúNuova sfida‚Äù solo se NON c‚Äô√® un ID ospite nel link
    const ALLOW_NEW_WHEN_GUEST_MISSING = true;

    // ‚Äî‚Äî‚Äî‚Äî‚Äî UTIL ‚Äî‚Äî‚Äî‚Äî‚Äî
    const $ = sel => document.querySelector(sel);

    function simpleHash(str){
      // piccolo hash deterministico (non crittografico)
      let h = 0;
      for (let i=0; i<str.length; i++){
        h = Math.imul(31, h) + str.charCodeAt(i) | 0;
      }
      return Math.abs(h);
    }

    function getQueryParams(){
      return new URLSearchParams(window.location.search);
    }

    function getGuestKey(){
      const params = getQueryParams();
      // supporta ?guest=  o ?id=
      return params.get("guest") || params.get("id") || null;
    }

    function loadSavedFor(guestKey){
      const k = guestKey ? `sfida_${guestKey}` : "sfida_default";
      const raw = localStorage.getItem(k);
      if(!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }

    function saveFor(guestKey, index){
      const k = guestKey ? `sfida_${guestKey}` : "sfida_default";
      localStorage.setItem(k, JSON.stringify({ index, ts: Date.now() }));
    }

    function pickDeterministicIndex(guestKey){
      // Se c‚Äô√® guestKey: scelta stabile in base all‚Äôhash
      if (guestKey){
        return simpleHash(guestKey) % challenges.length;
      }
      // Altrimenti, prova con un seed persistente
      let seed = localStorage.getItem("seed_default");
      if(!seed){
        seed = String(Date.now() + Math.random());
        localStorage.setItem("seed_default", seed);
      }
      return simpleHash(seed) % challenges.length;
    }

    function setChallenge(index){
      const text = challenges[index];
      const el = $("#challengeText");
      el.textContent = text;
      el.setAttribute("data-index", String(index));
      return text;
    }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî LOGICA PRINCIPALE ‚Äî‚Äî‚Äî‚Äî‚Äî
    (function init(){
      const guestKey = getGuestKey();
      const saved = loadSavedFor(guestKey);
      let index;

      if (saved && Number.isInteger(saved.index) && saved.index >= 0 && saved.index < challenges.length){
        index = saved.index; // mantieni la stessa sfida
      } else {
        index = pickDeterministicIndex(guestKey);
        saveFor(guestKey, index);
      }

      const text = setChallenge(index);

      // Bottoni
      $("#copyBtn").addEventListener("click", async () => {
        try{
          await navigator.clipboard.writeText(text);
          alert("Sfida copiata!");
        }catch{
          // fallback
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          ta.remove();
          alert("Sfida copiata!");
        }
      });

      $("#shareBtn").addEventListener("click", async () => {
        const shareData = {
          title: "La mia sfida üéâ",
          text,
          url: location.href
        };
        if (navigator.share){
          try { await navigator.share(shareData); } catch(e){}
        } else {
          // se Web Share non disponibile, copia
          try{
            await navigator.clipboard.writeText(`${text}\n${location.href}`);
            alert("Testo copiato per la condivisione!");
          }catch{
            alert("Condivisione non supportata. Puoi copiare manualmente.");
          }
        }
      });

      const hasGuest = Boolean(guestKey);
      $("#newBtn").style.display = (!hasGuest && ALLOW_NEW_WHEN_GUEST_MISSING) ? "inline-block" : "none";
      $("#newBtn").addEventListener("click", () => {
        // evita ripetizione immediata
        let newIdx;
        do { newIdx = Math.floor(Math.random() * challenges.length); }
        while (newIdx === index && challenges.length > 1);
        index = newIdx;
        const newText = setChallenge(index);
        saveFor(null, index);
      });
    })();
  </script>
</body>
</html>
